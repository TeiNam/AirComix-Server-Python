name: Create Initial Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Initial version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
        type: string

jobs:
  create-initial-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Check if tags exist
      id: check-tags
      run: |
        if git tag -l | grep -q .; then
          echo "has-tags=true" >> $GITHUB_OUTPUT
          echo "âš ï¸ íƒœê·¸ê°€ ì´ë¯¸ ì¡´ìž¬í•©ë‹ˆë‹¤. ê¸°ì¡´ íƒœê·¸:"
          git tag -l
        else
          echo "has-tags=false" >> $GITHUB_OUTPUT
          echo "âœ… íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ˆê¸° ë¦´ë¦¬ìŠ¤ë¥¼ ìƒì„±í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤."
        fi

    - name: Validate version format
      run: |
        VERSION="${{ github.event.inputs.version }}"
        if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "âŒ ìž˜ëª»ëœ ë²„ì „ í˜•ì‹ìž…ë‹ˆë‹¤. ì˜¬ë°”ë¥¸ í˜•ì‹: v1.0.0"
          exit 1
        fi
        echo "âœ… ë²„ì „ í˜•ì‹ì´ ì˜¬ë°”ë¦…ë‹ˆë‹¤: $VERSION"

    - name: Generate initial changelog
      run: |
        VERSION="${{ github.event.inputs.version }}"
        
        cat > changelog.md << EOF
        ## ðŸš€ AirComix Server Python Port $VERSION
        
        AirComix iOS ì•±ê³¼ 100% í˜¸í™˜ë˜ëŠ” ë§Œí™”ì±… ìŠ¤íŠ¸ë¦¬ë° ì„œë²„ì˜ ì²« ë²ˆì§¸ ê³µì‹ ë¦´ë¦¬ìŠ¤ìž…ë‹ˆë‹¤.
        
        ### âœ¨ ì£¼ìš” ê¸°ëŠ¥
        - ðŸš€ **FastAPI ê¸°ë°˜ ê³ ì„±ëŠ¥ ì„œë²„**: ë¹„ë™ê¸° ì²˜ë¦¬ë¡œ ë¹ ë¥¸ ì‘ë‹µ
        - ðŸ”’ **ë³´ì•ˆ ê°•í™”**: HTTP Basic Authentication ì§€ì›
        - ðŸ“¦ **Docker ì§€ì›**: ê°„íŽ¸í•œ ë°°í¬ ë° ê´€ë¦¬
        - ðŸŒ **ë‹¤êµ­ì–´ ì§€ì›**: í•œê¸€, ì¼ë³¸ì–´ íŒŒì¼ëª… ì™„ë²½ ì§€ì›
        - ðŸ§ª **ì•ˆì •ì„±**: í¬ê´„ì ì¸ í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸
        
        ### ðŸ“‹ ì§€ì› íŒŒì¼ í˜•ì‹
        - **ì´ë¯¸ì§€**: JPEG, PNG, GIF, BMP, TIFF, WebP
        - **ì•„ì¹´ì´ë¸Œ**: ZIP, RAR, CBZ, CBR
        
        ### ðŸ³ Docker ì´ë¯¸ì§€
        \`\`\`bash
        # ìµœì‹  ë²„ì „
        docker pull \${{ secrets.DOCKERHUB_USERNAME }}/aircomix-server:$VERSION
        docker pull \${{ secrets.DOCKERHUB_USERNAME }}/aircomix-server:latest
        
        # ë¹ ë¥¸ ì‹œìž‘
        docker run -d \\
          --name aircomix-server \\
          -p 31257:31257 \\
          -v /path/to/your/comix:/comix:ro \\
          \${{ secrets.DOCKERHUB_USERNAME }}/aircomix-server:$VERSION
        \`\`\`
        
        ### ðŸ”— ë§í¬
        - **GitHub**: https://github.com/TeiNam/AirComix-Server-Python
        - **Docker Hub**: https://hub.docker.com/r/\${{ secrets.DOCKERHUB_USERNAME }}/aircomix-server
        - **AirComix iOS ì•±**: https://apps.apple.com/app/aircomix/
        
        ### ðŸ“„ ë¼ì´ì„ ìŠ¤
        MIT License
        EOF

    - name: Create and push initial tag
      if: steps.check-tags.outputs.has-tags == 'false'
      run: |
        VERSION="${{ github.event.inputs.version }}"
        
        # Git ì„¤ì •
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # íƒœê·¸ ìƒì„±
        git tag -a "$VERSION" -m "Initial release $VERSION"
        git push origin "$VERSION"
        
        echo "âœ… ì´ˆê¸° íƒœê·¸ ìƒì„± ì™„ë£Œ: $VERSION"

    - name: Create GitHub Release
      if: steps.check-tags.outputs.has-tags == 'false'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.version }}
        name: "ðŸš€ AirComix Server ${{ github.event.inputs.version }}"
        body_path: ./changelog.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Skip if tags exist
      if: steps.check-tags.outputs.has-tags == 'true'
      run: |
        echo "âš ï¸ íƒœê·¸ê°€ ì´ë¯¸ ì¡´ìž¬í•˜ë¯€ë¡œ ì´ˆê¸° ë¦´ë¦¬ìŠ¤ ìƒì„±ì„ ê±´ë„ˆëœë‹ˆë‹¤."
        echo "ê¸°ì¡´ íƒœê·¸ë¥¼ í™•ì¸í•˜ê³  í•„ìš”ì‹œ ìˆ˜ë™ìœ¼ë¡œ ê´€ë¦¬í•˜ì„¸ìš”."