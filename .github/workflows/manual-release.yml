name: Manual Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ë¦´ë¦¬ìŠ¤ ë²„ì „ (ì˜ˆ: v1.2.3)'
        required: true
        type: string
      release_type:
        description: 'ë¦´ë¦¬ìŠ¤ íƒ€ì…'
        required: true
        default: 'release'
        type: choice
        options:
        - release
        - prerelease
        - hotfix
      changelog:
        description: 'ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ (ì„ íƒì‚¬í•­)'
        required: false
        type: string

jobs:
  manual-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Validate version format
      run: |
        VERSION="${{ github.event.inputs.version }}"
        if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
          echo "âŒ ì˜ëª»ëœ ë²„ì „ í˜•ì‹ì…ë‹ˆë‹¤. ì˜¬ë°”ë¥¸ í˜•ì‹: v1.2.3 ë˜ëŠ” v1.2.3-beta"
          exit 1
        fi
        echo "âœ… ë²„ì „ í˜•ì‹ì´ ì˜¬ë°”ë¦…ë‹ˆë‹¤: $VERSION"

    - name: Check if tag exists
      run: |
        VERSION="${{ github.event.inputs.version }}"
        if git tag -l | grep -q "^$VERSION$"; then
          echo "âŒ íƒœê·¸ $VERSIONì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤."
          exit 1
        fi
        echo "âœ… ìƒˆë¡œìš´ íƒœê·¸ì…ë‹ˆë‹¤: $VERSION"

    - name: Generate changelog
      id: changelog
      run: |
        VERSION="${{ github.event.inputs.version }}"
        RELEASE_TYPE="${{ github.event.inputs.release_type }}"
        CUSTOM_CHANGELOG="${{ github.event.inputs.changelog }}"
        
        # ìµœì‹  íƒœê·¸ ì°¾ê¸°
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        
        if [ -n "$CUSTOM_CHANGELOG" ]; then
          # ì‚¬ìš©ì ì •ì˜ ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸
          echo "## ğŸš€ $VERSION" > changelog.md
          echo "" >> changelog.md
          echo "$CUSTOM_CHANGELOG" >> changelog.md
        else
          # ìë™ ìƒì„± ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸
          echo "## ğŸš€ $VERSION" > changelog.md
          echo "" >> changelog.md
          
          if [ "$RELEASE_TYPE" = "hotfix" ]; then
            echo "### ğŸ”¥ Hotfix Release" >> changelog.md
            echo "ê¸´ê¸‰ ìˆ˜ì • ì‚¬í•­ì´ í¬í•¨ëœ ë¦´ë¦¬ìŠ¤ì…ë‹ˆë‹¤." >> changelog.md
          elif [ "$RELEASE_TYPE" = "prerelease" ]; then
            echo "### ğŸ§ª Pre-release" >> changelog.md
            echo "í…ŒìŠ¤íŠ¸ ëª©ì ì˜ ì‚¬ì „ ë¦´ë¦¬ìŠ¤ì…ë‹ˆë‹¤." >> changelog.md
          fi
          
          echo "" >> changelog.md
          echo "### ğŸ“‹ Changes" >> changelog.md
          
          if [ -n "$LATEST_TAG" ]; then
            git log $LATEST_TAG..HEAD --oneline --pretty=format:"- %s" >> changelog.md
          else
            echo "- ì´ˆê¸° ë¦´ë¦¬ìŠ¤" >> changelog.md
          fi
        fi
        
        echo "" >> changelog.md
        echo "### ğŸ³ Docker Images" >> changelog.md
        echo "\`\`\`bash" >> changelog.md
        echo "docker pull \${{ secrets.DOCKERHUB_USERNAME }}/aircomix-server:$VERSION" >> changelog.md
        echo "docker pull \${{ secrets.DOCKERHUB_USERNAME }}/aircomix-server:latest" >> changelog.md
        echo "\`\`\`" >> changelog.md
        
        # ì¶œë ¥ìš©
        CHANGELOG_CONTENT=$(cat changelog.md)
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create and push tag
      run: |
        VERSION="${{ github.event.inputs.version }}"
        
        # Git ì„¤ì •
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # íƒœê·¸ ìƒì„±
        git tag -a "$VERSION" -m "Manual release $VERSION"
        git push origin "$VERSION"
        
        echo "âœ… íƒœê·¸ ìƒì„± ë° í‘¸ì‹œ ì™„ë£Œ: $VERSION"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.version }}
        name: "Release ${{ github.event.inputs.version }}"
        body: ${{ steps.changelog.outputs.changelog }}
        draft: false
        prerelease: ${{ github.event.inputs.release_type == 'prerelease' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Summary
      run: |
        VERSION="${{ github.event.inputs.version }}"
        RELEASE_TYPE="${{ github.event.inputs.release_type }}"
        
        echo "ğŸ‰ ìˆ˜ë™ ë¦´ë¦¬ìŠ¤ ìƒì„± ì™„ë£Œ!"
        echo "ğŸ“¦ ë²„ì „: $VERSION"
        echo "ğŸ·ï¸ íƒ€ì…: $RELEASE_TYPE"
        echo "ğŸ³ Docker ì´ë¯¸ì§€ê°€ ìë™ìœ¼ë¡œ ë¹Œë“œë©ë‹ˆë‹¤."
        echo "ğŸ“‹ ë¦´ë¦¬ìŠ¤ í˜ì´ì§€: https://github.com/${{ github.repository }}/releases/tag/$VERSION"